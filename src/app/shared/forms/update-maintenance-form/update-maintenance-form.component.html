<app-generic-form [title]="'Update Maintenace Card'" (closeModal)="closeFormAndDestroy()">
    <form [formGroup]="form" class="space-y-6 p-4">
    <!-- Maintenance Information Section -->
        <div class="space-y-4">
            <h3 class="text-lg font-bold text-gray-900 dark:text-gray-100">Maintenance Information</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Card Number -->
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Card Number</label>
                    <div class="relative">
                        <input
                            class="w-full px-3 py-2 text-gray-800 dark:text-gray-100 bg-gray-200 dark:bg-gray-800 rounded border border-gray-300 dark:border-gray-600 focus:outline-none cursor-not-allowed"
                            formControlName="maintenanceNumber"
                            readonly
                            />
                    </div>
                </div>

                <!-- Status Selector -->
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Status</label>
                    <div class="flex rounded-full overflow-hidden border border-gray-300 w-fit shadow-sm">
                        <div
                            *ngFor="let status of statuses"
                            class="w-10 h-10 flex items-center justify-center cursor-pointer transition-colors duration-200 hover:bg-opacity-90"
                            [ngClass]="getStatusClasses(status)"
                            (click)="setStatus(status)"
                        >
                            <div class="w-3 h-3 rounded-full"
                            [ngClass]="{
                                'bg-green-600': status === 'Completed',
                                'bg-amber-500': status === 'Pending',
                                'bg-red-600': status === 'Canceled'
                            }">
                            </div>
                        </div>
                        </div>
                </div>

                <!-- Ready to Deliver Toggle -->
                <div class="flex items-center space-x-4 pt-6">
                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Ready to be Delivered?</label>
                    <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" formControlName="isReadyToBeDelivered" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-green-600">
                    </div>
                    </label>
                </div>
            </div>

            <!-- Date Inputs -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Date In</label>
                    <input 
                    class="w-full px-3 py-2 text-gray-800 dark:text-gray-100 bg-gray-200 dark:bg-gray-800 rounded border border-gray-300 dark:border-gray-600 focus:outline-none cursor-not-allowed"
                    formControlName="dateIn" 
                    readonly 
                    />
                </div>
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Date Out</label>
                    <input 
                    class="w-full px-3 py-2 text-gray-800 dark:text-gray-100 bg-gray-200 dark:bg-gray-800 rounded border border-gray-300 dark:border-gray-600 focus:outline-none cursor-not-allowed"
                    formControlName="dateOut" 
                    readonly 
                    />
                </div>
            </div>
        </div>

    <!-- Customer Information Section -->
        <div class="space-y-4">
            <h3 class="text-lg font-bold text-gray-900 dark:text-gray-100">Customer Information</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Customer First Name</label>
                    <input 
                    class="w-full px-3 py-2 text-gray-800 dark:text-gray-100 bg-gray-200 dark:bg-gray-800 rounded border border-gray-300 dark:border-gray-600 focus:outline-none cursor-not-allowed"
                    formControlName="customerFirstName" 
                    readonly 
                    />
                </div>
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Customer Father Name</label>
                    <input 
                    class="w-full px-3 py-2 text-gray-800 dark:text-gray-100 bg-gray-200 dark:bg-gray-800 rounded border border-gray-300 dark:border-gray-600 focus:outline-none cursor-not-allowed"
                    formControlName="customerFatherName" 
                    readonly 
                    />
                </div>
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Customer Last Name</label>
                    <input 
                    class="w-full px-3 py-2 text-gray-800 dark:text-gray-100 bg-gray-200 dark:bg-gray-800 rounded border border-gray-300 dark:border-gray-600 focus:outline-none cursor-not-allowed"
                    formControlName="customerLastName" 
                    readonly 
                    />
                </div>
            </div>
        </div>

        <!-- Vehicle Information Section -->
        <div class="space-y-4">
            <h3 class="text-lg font-bold text-gray-900 dark:text-gray-100">Customer Vehicle Information</h3>
            <div class="space-y-4">
                <!-- VIN -->
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Vehicle Identification Number (VIN)</label>
                    <input 
                        class="w-full px-3 py-2 text-gray-800 dark:text-gray-100 bg-gray-200 dark:bg-gray-800 rounded border border-gray-300 dark:border-gray-600 focus:outline-none cursor-not-allowed"
                        formControlName="vin" 
                        readonly 
                    />
                </div>

                <!-- Brand/Model/Year -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Vehicle Brand</label>
                        <input 
                        class="w-full px-3 py-2 text-gray-800 dark:text-gray-100 bg-gray-200 dark:bg-gray-800 rounded border border-gray-300 dark:border-gray-600 focus:outline-none cursor-not-allowed"
                        formControlName="brand" 
                        readonly 
                        />
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Vehicle Model</label>
                        <input 
                        class="w-full px-3 py-2 text-gray-800 dark:text-gray-100 bg-gray-200 dark:bg-gray-800 rounded border border-gray-300 dark:border-gray-600 focus:outline-none cursor-not-allowed"
                        formControlName="model" 
                        readonly 
                        />
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Vehicle Model Year</label>
                        <input 
                        class="w-full px-3 py-2 text-gray-800 dark:text-gray-100 bg-gray-200 dark:bg-gray-800 rounded border border-gray-300 dark:border-gray-600 focus:outline-none cursor-not-allowed"
                        formControlName="yearModel" 
                        readonly 
                        />
                    </div>
                </div>

                <!-- Plate/Color -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Vehicle Plate</label>
                        <input 
                        class="w-full px-3 py-2 text-gray-800 dark:text-gray-100 bg-gray-200 dark:bg-gray-800 rounded border border-gray-300 dark:border-gray-600 focus:outline-none cursor-not-allowed"
                        formControlName="plate" 
                        readonly 
                        />
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Vehicle Color</label>
                        <input 
                        class="w-full px-3 py-2 text-gray-800 dark:text-gray-100 bg-gray-200 dark:bg-gray-800 rounded border border-gray-300 dark:border-gray-600 focus:outline-none cursor-not-allowed"
                        formControlName="color" 
                        readonly 
                        />
                    </div>
                </div>
            </div>
        </div>
</form>

    <h3 class="text-lg font-bold text-black dark:text-[#eee] m-3">Description Information</h3>
    <div class="m-3">
        <table class="min-w-full  divide-y divide-gray-200 dark:divide-gray-700 border border-gray-800 dark:border-gray-600">
            <thead class="bg-[#6B7C9D]  text-white">
                <tr>
                    <th class="px-4 py-2 text-left">Description</th>
                </tr>
            </thead>
            <tbody class="bg-zinc-300  text-gray-900 ">
                <tr *ngFor="let s of maintenance.maintenanceDescriptions; let i = index"
                >
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">
                        <input
                        placeholder="Enter Your Description"
                        [(ngModel)]="s.text" 
                        class="px-3 py-2 
                        text-md text-gray-800 dark:text-gray-100
                        input-class w-[90%] 
                        bg-white dark:bg-[#2a2b2f] 
                        rounded border border-gray-300 dark:border-gray-700 
                        focus:border-[#6B7C9D] focus:ring-3 focus:ring-[#6B7C9D] focus:outline-none" />
                        <button
                            *ngIf="!s.id"
                            class="text-red-600 hover:text-red-800 m-4"
                            (click)="removeDescription(i)"> 
                            ✖
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>
        <div class="m-3">
            <button
            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
            (click)="addDescription()"
            >
            Add Description
            </button>
        </div>
    </div>

<hr class="m-2 bg-gray-200">
    <!-- Services Table Section -->
    <h3 class="text-lg font-bold text-black dark:text-[#eee] m-3">Services Information</h3>
    <div class="m-3">
        <div class="overflow-y-auto">
                <table class="min-w-full divide-y divide-gray-200 border border-gray-800">
                    <thead class="bg-[#6B7C9D] text-white">
                        <tr>
                        <th class="px-4 py-2 text-center w-12">#</th>
                        <th class="px-4 py-2 text-center min-w-[200px]">Service Type</th>
                        <th class="px-4 py-2 text-center min-w-[200px]">Service Name</th>
                        <th class="px-4 py-2 text-center min-w-[300px]">Cost</th>
                        <th class="px-4 py-2 text-center w-24">Completed</th>
                        <th class="px-4 py-2 text-center w-24">Pending</th>
                        <th class="px-4 py-2 text-center w-24">Canceled</th>
                        <th class="px-4 py-2 text-center min-w-[150px]">Emp</th>
                        <th class="px-4 py-2 text-center max-w-[7.5%]">Action</th>
                        </tr>
                    </thead>
                    <tbody class="bg-zinc-300 dark:bg-gray-900 text-gray-900 dark:text-gray-100" >
                        <!-- Service Row -->
                    <ng-container *ngFor="let s of maintenance.maintenaceServices; let i = index">
                    <!-- Service Row -->
                    <tr>
                        <td class="px-4 py-3 text-sm font-semibold text-gray-800 dark:text-gray-200">{{ i + 1 }}</td>
                        <!-- Service Type Dropdown -->
                        <td class="px-4 py-3">
                        <select 
                            class="w-full p-2
                            text-md text-gray-800 dark:text-gray-100
                            bg-white dark:bg-[#2a2b2f] 
                            rounded border border-gray-300 dark:border-gray-700 
                            focus:border-[#6B7C9D] focus:ring-3 focus:ring-[#6B7C9D] focus:outline-none"
                            [(ngModel)]="s.service!.serviceTypeId"
                            (change)="onServiceTypeChange(s, $event)">
                            <option *ngFor="let type of serviceTypes" [value]="type.id">{{ type.name }}</option>
                        </select>
                        </td>

                        <!-- Service Name Dropdown -->
                        <td class="px-4 py-3">
                        <select 
                            class="w-full p-2
                            text-md text-gray-800 dark:text-gray-100
                            bg-white dark:bg-[#2a2b2f] 
                            rounded border border-gray-300 dark:border-gray-700 
                            focus:border-[#6B7C9D] focus:ring-3 focus:ring-[#6B7C9D] focus:outline-none"
                            [(ngModel)]="s.serviceId">
                            <option value="" disabled>Select service</option>
                            <option *ngFor="let svc of s.availableServices || []" [value]="svc.id">{{ svc.name }}</option>
                        </select>
                        </td>

                        <!-- Cost Input -->
                        <td class="px-4 py-3">
                        <input type="number"
                            class=" p-2
                            text-md text-gray-800 dark:text-gray-100
                            input-class w-full 
                            bg-white dark:bg-[#2a2b2f] 
                            rounded border border-gray-300 dark:border-gray-700 
                            focus:border-[#6B7C9D] focus:ring-3 focus:ring-[#6B7C9D] focus:outline-none"
                            min="0" placeholder="Cost" [(ngModel)]="s.cost" />
                        </td>

                        <!-- Status Checkboxes -->
     <!-- Completed -->
<td class="px-4 py-3 text-center border border-gray-300 dark:border-gray-700">
  <button (click)="setStatusForService(s, 'completed')"
          class="w-8 h-8 flex items-center justify-center rounded-full transition
                 text-gray-700"
          [ngClass]="{
            'bg-green-600': s.isCompleted,
            'bg-gray-300 dark:bg-gray-600': !s.isCompleted
          }"
          title="Completed">
    ✓
  </button>
</td>

<!-- Pending -->
<td class="px-4 py-3 text-center border border-gray-300 dark:border-gray-700">
  <button (click)="setStatusForService(s, 'pending')"
          class="w-8 h-8 flex items-center justify-center rounded-full transition
                 text-gray-700"
          [ngClass]="{
            'bg-yellow-500 ': s.isPending,
            'bg-gray-300 dark:bg-gray-600': !s.isPending
          }"
          title="Pending">
    👁
  </button>
</td>

<!-- Canceled -->
<td class="px-4 py-3 text-center border border-gray-300 dark:border-gray-700">
  <button (click)="setStatusForService(s, 'canceled')"
          class="w-8 h-8 flex items-center justify-center rounded-full transition
                 text-gray-700"
          [ngClass]="{
            'bg-red-600': s.isCanceled,
            'bg-gray-300 dark:bg-gray-600': !s.isCanceled
          }"
          title="Canceled">
    ✗
  </button>
</td>

                        <!-- Employee Selector -->
                        <td class="px-4 py-3 relative">
                        <button type="button"
                                (click)="toggleEmployeeDropdown(s)"
                            class=" p-2
                            text-md text-gray-800 dark:text-gray-100
                            input-class w-full 
                            bg-white dark:bg-[#2a2b2f] 
                            rounded border border-gray-300 dark:border-gray-700 
                            focus:border-[#6B7C9D] focus:ring-3 focus:ring-[#6B7C9D] focus:outline-none" 
                        >Select Emp
                        </button>
                        <div *ngIf="isDropdownOpen(s)"
                            class="w-full absolute
                            text-md text-gray-800 dark:text-gray-100
                            bg-white dark:bg-[#2a2b2f] 
                            rounded border border-gray-300 dark:border-gray-700 
                            focus:border-[#6B7C9D] focus:ring-3 focus:ring-[#6B7C9D] focus:outline-none overflow-y-auto">
                            <label *ngFor="let emp of employees" class="flex items-center px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700">
                            <input type="checkbox" [checked]="isEmployeeAlreadySelected(s, emp)" (change)="toggleEmployeeForService(s, emp)" />
                            <span class="ml-2">{{ emp.firstName }} {{ emp.lastName }}</span>
                            </label>
                        </div>
                        </td>

                        <!-- Remove service button -->
                        <td  class="px-2 py-3 text-center">
                        <button *ngIf="!s.id" (click)="removeNewService(i)"
                        class="bg-red-600 text-white rounded px-2 py-1 hover:bg-red-700">
                            ✖
                        </button>
                        </td>
                    </tr>

                    <!-- Notes -->
                    <tr *ngFor="let note of s.maintenanceServiceNotes; let j = index">
                    <td colspan="7"
                    class="px-6 py-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- Note -->
                            <div>
                            <label class="text-sm font-medium ">Note</label>
                            <textarea [(ngModel)]="note.text"
                            [disabled]="!!note.createdBy && note.createdBy != currentUserId"
                            class=" p-2
                            disabled:bg-[#353535] disabled:dark:bg-gray-700
                            disabled:text-white disabled:cursor-not-allowed
                            text-md text-gray-800 dark:text-gray-100
                            input-class w-full 
                            bg-white dark:bg-[#2a2b2f] 
                            rounded border border-gray-300 dark:border-gray-700 
                            focus:border-[#6B7C9D] focus:ring-3 focus:ring-[#6B7C9D] focus:outline-none"            
                            ></textarea>
                            </div>

                            <!-- Fault Code -->
                            <div>
                            <label class="text-sm font-medium ">Fault Code</label>
                            <textarea [(ngModel)]="note.fualtCode"
                            [disabled]="!!note.createdBy && note.createdBy != currentUserId"
                            class=" p-2
                            disabled:bg-[#353535] disabled:dark:bg-gray-700
                            disabled:text-white disabled:cursor-not-allowed
                            text-md text-gray-800 dark:text-gray-100
                            input-class w-full 
                            bg-white dark:bg-[#2a2b2f] 
                            rounded border border-gray-300 dark:border-gray-700 
                            focus:border-[#6B7C9D] focus:ring-3 focus:ring-[#6B7C9D] focus:outline-none">
                            </textarea>
                            </div>

                            <!-- How to Fix It -->
                            <div>
                            <label class="text-sm font-medium">How to Fix It</label>
                            <textarea [(ngModel)]="note.howToFixIt"
                            [disabled]="!!note.createdBy && note.createdBy != currentUserId"
                            class=" p-2
                            disabled:bg-[#353535] disabled:dark:bg-gray-700
                            disabled:text-white disabled:cursor-not-allowed
                            text-md text-gray-800 dark:text-gray-100
                            input-class w-full 
                            bg-white dark:bg-[#2a2b2f] 
                            rounded border border-gray-300 dark:border-gray-700 
                            focus:border-[#6B7C9D] focus:ring-3 focus:ring-[#6B7C9D] focus:outline-none">
                            </textarea>
                            </div>
                            </div>

                        <!-- Delete Note Button -->
                        <div *ngIf="!note.id" class="mt-4 text-right">
                            <button (click)="removeNewNote(s, j)" class="text-sm bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700">
                            Delete Note
                            </button>
                        </div>
                        </td>
                        <td colspan="2">
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">
                            <span class="flex items-center space-x-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A9.001 9.001 0 0112 3a9.001 9.001 0 016.879 14.804M15 11a3 3 0 11-6 0 3 3 0 016 0zm-6 8h6" />
                            </svg>
                            <span class="text-red-600">Created By</span>
                            </span>
                        </label>

                        <div class="bg-red-100 dark:bg-red-800 text-red-800 dark:text-red-200 p-2 rounded text-lg font-medium shadow-sm">
                            {{ getEmployeeName(note.createdBy!) || 'Loading...' }}
                        </div>
                        </td>
                    </tr>

                    <!-- Add Note Button -->
                    <tr class="border-t border-gray-300 dark:border-gray-700 bg-gray-100 dark:bg-gray-900">
                        <td colspan="10" class="px-6 py-3 text-right">
                        <button (click)="addNoteToService2(s)"
                                class="bg-blue-600 text-white text-sm px-4 py-2 rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-[#6B7C9D]">
                            + Add Note
                        </button>
                        </td>
                    </tr>
                    </ng-container>

                    </tbody>
                    </table>
                </div>
            </div>
<!-- Action Buttons -->
    <div class="flex justify-between items-center p-4 border-t border-gray-200 dark:border-gray-700">
        <button
        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors"
        (click)="addNewService()">
        + Add Service
        </button>
        <button 
        class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors"
        (click)="saveUpdatedMaintenance()">
        Save Changes
        </button>
    </div>


</app-generic-form>